<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Focus Memo - Deep Work Assistant</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Firebase SDK (Compat Version for stability) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap');
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #0a0a0a; 
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            color: #fff;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .loading-screen {
            position: fixed;
            inset: 0;
            background: #0a0a0a;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        /* Glassmorphism Effect */
        .glass {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
    </style>
</head>
<body>
    <div id="root">
        <div class="loading-screen text-indigo-500 font-bold tracking-widest animate-pulse">
            INITIALIZING FOCUS MEMO...
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyD1VYynHIxmFPltNIa9-kHGn9_iXTHhV1Q",
            authDomain: "mymeno-8f33d.firebaseapp.com",
            projectId: "mymeno-8f33d",
            storageBucket: "mymeno-8f33d.firebasestorage.app",
            messagingSenderId: "855905855410",
            appId: "1:855905855410:web:0f0b423c31a2956a4ae6ab",
            measurementId: "G-83Q5VEXBYS"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();
        const googleProvider = new firebase.auth.GoogleAuthProvider();

        const CATEGORIES = [
            { id: 'idea', label: '아이디어', icon: 'lightbulb', color: 'text-yellow-400', bg: 'bg-yellow-400/10' },
            { id: 'schedule', label: '일정', icon: 'calendar', color: 'text-blue-400', bg: 'bg-blue-400/10' },
            { id: 'mindset', label: '부자마인드', icon: 'trending-up', color: 'text-green-400', bg: 'bg-green-400/10' },
            { id: 'reading', label: '독서기록', icon: 'book-open', color: 'text-purple-400', bg: 'bg-purple-400/10' },
        ];

        const Icon = ({ name, size = 16, className = "" }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (window.lucide && iconRef.current) {
                    window.lucide.createIcons({
                        icons: { [name]: window.lucide.icons[name] },
                        nameAttr: 'data-lucide'
                    });
                }
            }, [name]);
            return (
                <span ref={iconRef} className={`inline-flex items-center justify-center ${className}`}>
                    <i data-lucide={name} style={{ width: size, height: size }}></i>
                </span>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [memos, setMemos] = useState([]);
            const [inputText, setInputText] = useState('');
            const [selectedCategory, setSelectedCategory] = useState('idea');
            const [filterCategory, setFilterCategory] = useState('all');
            const [isListening, setIsListening] = useState(false);
            const [isLoading, setIsLoading] = useState(true);
            const [snackbar, setSnackbar] = useState({ show: false, message: '', type: 'success' });
            const recognitionRef = useRef(null);

            // 1. Auth Listener & Data Fetching
            useEffect(() => {
                let unsubscribeMemos = () => {};

                const unsubscribeAuth = auth.onAuthStateChanged((currentUser) => {
                    setUser(currentUser);
                    setIsLoading(false);

                    if (currentUser) {
                        // 중요: where와 orderBy를 섞으면 인덱스 에러가 날 수 있으므로, 
                        // 조회를 먼저하고 자바스크립트 단에서 정렬하도록 안전하게 변경합니다.
                        unsubscribeMemos = db.collection('memos')
                            .where('userId', '==', currentUser.uid)
                            .onSnapshot((snapshot) => {
                                const items = snapshot.docs.map(doc => ({
                                    id: doc.id,
                                    ...doc.data()
                                }));
                                // 최신순 정렬
                                items.sort((a, b) => {
                                    const timeA = a.createdAt?.seconds || new Date(a.createdAt).getTime() || 0;
                                    const timeB = b.createdAt?.seconds || new Date(b.createdAt).getTime() || 0;
                                    return timeB - timeA;
                                });
                                setMemos(items);
                            }, (err) => {
                                console.error("Firestore error:", err);
                                // 인덱스 문제일 경우 콘솔에 생성 링크가 뜹니다.
                                if (err.code === 'failed-precondition') {
                                    showSnackbar("인덱스 생성 필요(콘솔 확인)", "error");
                                } else if (err.code === 'permission-denied') {
                                    showSnackbar("Firestore 보안 규칙 확인 필요", "error");
                                } else {
                                    showSnackbar("데이터 동기화 오류", "error");
                                }
                            });
                    } else {
                        const saved = localStorage.getItem('focus-memos-local');
                        if (saved) setMemos(JSON.parse(saved));
                        else setMemos([]);
                    }
                });

                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (SpeechRecognition) {
                    recognitionRef.current = new SpeechRecognition();
                    recognitionRef.current.lang = 'ko-KR';
                    recognitionRef.current.onresult = (event) => {
                        const transcript = event.results[0][0].transcript;
                        saveMemo(transcript, 'Voice');
                        setIsListening(false);
                    };
                    recognitionRef.current.onend = () => setIsListening(false);
                }

                return () => {
                    unsubscribeAuth();
                    unsubscribeMemos();
                };
            }, []);

            const showSnackbar = (message, type = 'success') => {
                setSnackbar({ show: true, message, type });
                setTimeout(() => setSnackbar({ show: false, message: '', type: 'success' }), 4000);
            };

            const handleLogin = async () => {
                try {
                    await auth.signInWithPopup(googleProvider);
                    showSnackbar("로그인 성공!");
                } catch (error) {
                    console.error("Login Error:", error);
                    showSnackbar(`로그인 오류: ${error.code}`, "error");
                }
            };

            const handleLogout = async () => {
                try {
                    await auth.signOut();
                    showSnackbar("로그아웃 되었습니다.");
                } catch (error) {
                    showSnackbar("로그아웃 실패", "error");
                }
            };

            const saveMemo = async (text, type = 'Keyboard') => {
                const content = typeof text === 'string' ? text : inputText;
                if (!content.trim()) return;

                const memoData = {
                    content: content,
                    inputType: type,
                    categoryId: selectedCategory,
                    createdAt: new Date().toISOString()
                };

                if (user) {
                    try {
                        // 서버 타임스탬프를 사용하여 정확한 시간을 기록합니다.
                        await db.collection('memos').add({
                            ...memoData,
                            userId: user.uid,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        setInputText('');
                        showSnackbar("클라우드 저장 완료");
                    } catch (e) {
                        console.error("Save error details:", e);
                        if (e.code === 'permission-denied') {
                            showSnackbar("Firestore 규칙(Rules)을 확인하세요.", "error");
                        } else {
                            showSnackbar("서버 저장 실패", "error");
                        }
                    }
                } else {
                    const newMemo = { ...memoData, id: Date.now() };
                    const updated = [newMemo, ...memos];
                    setMemos(updated);
                    localStorage.setItem('focus-memos-local', JSON.stringify(updated));
                    setInputText('');
                    showSnackbar("로컬 저장됨");
                }
            };

            const deleteMemo = async (id) => {
                if (user) {
                    try {
                        await db.collection('memos').doc(id).delete();
                        showSnackbar("삭제 완료");
                    } catch (e) {
                        showSnackbar("삭제 실패", "error");
                    }
                } else {
                    const updated = memos.filter(m => m.id !== id);
                    setMemos(updated);
                    localStorage.setItem('focus-memos-local', JSON.stringify(updated));
                    showSnackbar("삭제 완료");
                }
            };

            const toggleListening = () => {
                if (isListening) {
                    recognitionRef.current?.stop();
                } else {
                    if (!recognitionRef.current) {
                        showSnackbar('음성 인식을 지원하지 않는 브라우저입니다.', 'error');
                        return;
                    }
                    setIsListening(true);
                    recognitionRef.current.start();
                }
            };

            const filteredMemos = filterCategory === 'all' 
                ? memos 
                : memos.filter(m => m.categoryId === filterCategory);

            const getCategoryInfo = (id) => CATEGORIES.find(c => c.id === id) || CATEGORIES[0];

            if (isLoading) {
                return (
                    <div className="loading-screen text-indigo-500 font-bold tracking-widest animate-pulse">
                        SYNCING DATA...
                    </div>
                );
            }

            return (
                <div className="min-h-screen text-gray-100 flex flex-col pb-48">
                    {/* Header */}
                    <header className="p-4 border-b border-white/5 flex justify-between items-center glass sticky top-0 z-40">
                        <div className="flex items-center gap-3">
                            <div className="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center shadow-lg">
                                <Icon name="type" size={20} className="text-white" />
                            </div>
                            <div>
                                <h1 className="text-lg font-bold tracking-tight leading-none">Focus Memo</h1>
                                <p className="text-[10px] text-gray-500 mt-1 uppercase tracking-widest">
                                    {user ? "Cloud Synced" : "Local Mode"}
                                </p>
                            </div>
                        </div>
                        
                        <div>
                            {user ? (
                                <div className="flex items-center gap-3">
                                    <div className="hidden sm:block text-right">
                                        <p className="text-[10px] text-gray-400 font-bold">{user.displayName}</p>
                                        <p className="text-[8px] text-gray-600 uppercase tracking-tighter">Verified User</p>
                                    </div>
                                    <img src={user.photoURL} className="w-8 h-8 rounded-full border border-indigo-500/30" alt="profile" />
                                    <button onClick={handleLogout} className="ml-2 text-[10px] bg-white/5 hover:bg-white/10 px-3 py-1.5 rounded-full border border-white/10 text-gray-400 font-bold transition-all">
                                        LOGOUT
                                    </button>
                                </div>
                            ) : (
                                <button onClick={handleLogin} className="flex items-center gap-2 text-[10px] bg-indigo-600 text-white px-4 py-2 rounded-full font-bold hover:bg-indigo-500 transition-all shadow-lg shadow-indigo-600/20">
                                    <Icon name="log-in" size={12} />
                                    GOOGLE LOGIN
                                </button>
                            )}
                        </div>
                    </header>

                    {/* Filter Tabs */}
                    <div className="bg-[#0a0a0a]/80 backdrop-blur-md border-b border-white/5 px-4 py-4 sticky top-[73px] z-30 overflow-x-auto no-scrollbar">
                        <div className="flex gap-2 max-w-2xl mx-auto">
                            <button
                                onClick={() => setFilterCategory('all')}
                                className={`px-5 py-2 rounded-xl text-xs font-bold transition-all whitespace-nowrap ${
                                    filterCategory === 'all' ? 'bg-indigo-600 text-white shadow-lg' : 'bg-white/5 text-gray-500 hover:bg-white/10'
                                }`}
                            >전체</button>
                            {CATEGORIES.map(cat => (
                                <button
                                    key={cat.id}
                                    onClick={() => setFilterCategory(cat.id)}
                                    className={`px-5 py-2 rounded-xl text-xs font-bold transition-all flex items-center gap-2 whitespace-nowrap ${
                                        filterCategory === cat.id ? 'bg-indigo-600 text-white shadow-lg' : 'bg-white/5 text-gray-500 hover:bg-white/10'
                                    }`}
                                >
                                    <Icon name={cat.icon} size={14} className={filterCategory === cat.id ? 'text-white' : cat.color} />
                                    {cat.label}
                                </button>
                            ))}
                        </div>
                    </div>

                    {/* List Area */}
                    <main className="flex-1 p-4 max-w-2xl mx-auto w-full space-y-4">
                        {filteredMemos.length === 0 ? (
                            <div className="h-64 flex flex-col items-center justify-center text-gray-600 gap-3 opacity-50 text-center">
                                <Icon name="database" size={40} />
                                <p className="text-sm">저장된 메모가 없습니다.<br/><span className="text-[10px]">로그인하면 다른 기기에서도 확인 가능합니다.</span></p>
                            </div>
                        ) : (
                            filteredMemos.map((memo) => {
                                const cat = getCategoryInfo(memo.categoryId);
                                return (
                                    <div key={memo.id} className="group bg-[#111] border border-white/5 p-6 rounded-3xl hover:border-white/10 transition-all relative">
                                        <div className="flex justify-between items-start mb-4">
                                            <div className="flex gap-2 items-center">
                                                <span className={`flex items-center gap-1.5 px-3 py-1 rounded-lg text-[10px] font-bold uppercase ${cat.bg} ${cat.color}`}>
                                                    <Icon name={cat.icon} size={10} /> {cat.label}
                                                </span>
                                                <span className="text-[9px] text-gray-600 uppercase font-bold tracking-tighter">{memo.inputType}</span>
                                            </div>
                                            <div className="flex items-center gap-3">
                                                <span className="text-[10px] text-gray-600">
                                                    {memo.createdAt?.seconds 
                                                        ? new Date(memo.createdAt.seconds * 1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
                                                        : new Date(memo.createdAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
                                                    }
                                                </span>
                                                <button onClick={() => deleteMemo(memo.id)} className="text-gray-700 hover:text-red-500 transition-colors p-1">
                                                    <Icon name="trash-2" size={14} />
                                                </button>
                                            </div>
                                        </div>
                                        <p className="text-gray-300 text-[15px] leading-relaxed whitespace-pre-wrap">{memo.content}</p>
                                    </div>
                                );
                            })
                        )}
                    </main>

                    {/* Fixed Input Bar */}
                    <div className="fixed bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-[#0a0a0a] via-[#0a0a0a] to-transparent z-40">
                        <div className="max-w-2xl mx-auto space-y-4">
                            <div className="flex gap-2 overflow-x-auto no-scrollbar py-1">
                                {CATEGORIES.map(cat => (
                                    <button
                                        key={cat.id}
                                        onClick={() => setSelectedCategory(cat.id)}
                                        className={`px-4 py-2 rounded-2xl text-[11px] font-bold flex items-center gap-2 transition-all border shrink-0 ${
                                            selectedCategory === cat.id ? `bg-white ${cat.color} border-white shadow-xl` : 'bg-[#1a1a1a] text-gray-500 border-white/5'
                                        }`}
                                    >
                                        <Icon name={cat.icon} size={12} /> {cat.label}
                                    </button>
                                ))}
                            </div>
                            <div className="bg-[#1a1a1a] border border-white/5 rounded-[28px] shadow-2xl p-2 flex items-center gap-2 focus-within:ring-2 ring-indigo-500/50 transition-all">
                                <button 
                                    onClick={toggleListening} 
                                    className={`p-4 rounded-2xl transition-all ${isListening ? 'bg-red-500 text-white animate-pulse' : 'bg-white/5 text-gray-400 hover:text-white'}`}
                                >
                                    <Icon name={isListening ? "mic-off" : "mic"} size={22} />
                                </button>
                                <input 
                                    type="text"
                                    value={inputText}
                                    onChange={(e) => setInputText(e.target.value)}
                                    onKeyPress={(e) => e.key === 'Enter' && saveMemo()}
                                    placeholder={isListening ? "기록을 시작하세요..." : `${getCategoryInfo(selectedCategory).label} 기록...`}
                                    className="flex-1 bg-transparent border-none focus:ring-0 text-white py-3 px-2 text-base"
                                />
                                <button 
                                    onClick={() => saveMemo()} 
                                    disabled={!inputText.trim()} 
                                    className={`p-4 rounded-2xl transition-all ${inputText.trim() ? 'bg-indigo-600 text-white shadow-lg' : 'text-gray-700'}`}
                                >
                                    <Icon name="send" size={22} />
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* Snackbar */}
                    {snackbar.show && (
                        <div className="fixed bottom-40 left-1/2 -translate-x-1/2 z-50 w-full max-w-xs px-4">
                            <div className={`px-4 py-3 rounded-2xl shadow-2xl flex items-center gap-3 border backdrop-blur-md ${
                                snackbar.type === 'error' ? 'bg-red-900/90 border-red-500/30 text-white' : 'bg-white/10 border-white/20 text-white'
                            }`}>
                                <Icon name={snackbar.type === 'error' ? "alert-circle" : "check-circle"} size={16} />
                                <span className="text-[13px] font-medium leading-tight">{snackbar.message}</span>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
